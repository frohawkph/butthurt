<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-selector/core-selector.html">
<link rel="import" href="bower_components/core-icon/core-icon.html">
<link rel="import" href="bower_components/core-icons/core-icons.html">
<link rel="import" href="bower_components/core-icons/hardware-icons.html">
<link rel="import" href="bower_components/core-icons/av-icons.html">
<link rel="import" href="bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="bower_components/font-roboto/roboto.html">
<link rel="import" href="bh-instance.html">
<link rel="import" href="bh-date-circle.html">

<polymer-element name="bh-app" attributes="buttList" autofocus fit vertical layout on-keydown="{{keyHandler}}">
  <template>
    <style>
      :host {
        font-family: RobotoDraft;
      }
      #pagecontrols {
        background-color: #870E49;
        color: white;
      }
      #list {
        z-index: 0;
      }
      a.inline {
        transition: all 0.2s;
        display: inline-block;
        color: #870E49;
        box-shadow: 0px -1px 0px #870E49 inset;
        text-decoration: none;
        margin: 0px;
      }
      a.inline:hover {
        /*box-shadow: 0px 4px 4px rgba(0,0,0,0.2);*/
        color: white;
        box-shadow: 0px -24px 0px #870E49 inset;
      }
      a.inline:active {
        box-shadow: 0px -24px 0px #870E49 inset, 0px 0px 0px 8px #870E49;
      }
      .container {
        position: relative;
        z-index: 1;
        -webkit-flex-shrink: 0;
        flex-shrink: 0;
        padding: 16px 0px;
        left: -8px;
      }
      .container bh-date-circle {
        z-index: 1;
        height: 80px;
        width: 80px;
        margin-right: -8px;
        margin-left: -8px;
        color: #870E49;
      }
      .container h1 {
        font-weight: 300;
        margin: 0;
      }
      .container .line {
        position: absolute;
        z-index: -1;
        top: 96px;
        bottom: -20px;
        left: 32px;
        width: 2px;
        background-color: #870E49;
      }
    </style>

    <core-ajax
    auto
    url="data.csv"
    handleAs="text"
    on-core-error="{{dataErrorHandler}}"
    on-core-response="{{dataHandler}}"
    loading="{{loadingData}}"
    ></core-ajax>

<!--       <div fit vertical layout center center-justified>
        <paper-spinner active="{{loadingData}}"></paper-spinner>
      </div>
      what -->
    <div class="buttlist" layout vertical flex>
      <core-header-panel id="scrollpanel" mode="scroll" flex on-scroll="{{scrollHandler}}">
        <core-toolbar style="display: none;">
        </core-toolbar>
        <div fit layout vertical center>
          <div style="position: relative; width: 384px" layout vertical>
            
            <div class="container" horizontal layout flex-start>
              <bh-date-circle class="outline">
                Now
              </bh-date-circle>
              <div style="padding: 16px; color: #333;">
                <h1>{{daysSinceDate(latestDate(buttList))}} days since last butthurt</h1>
                <p>
                  Butthurt is a tribute to Filipino (over)sensitivities, and nothing more.
                </p>
                <p>
                  If you'd like to suggest a new entry, click <a class="inline" href="https://docs.google.com/forms/d/1Cexh4k5-nfwX9RKmv7Dwd4DcGweXLh8Kn6iZXbob0hU/viewform">here</a> or drop us a <a class="inline" href="https://github.com/torchapps/butthurt">pull request</a>!
                </p>
                <p>
                  Made by <a class="inline" href="https://torchapps.github.io/">Torch</a>
                </p>
              </div>
              <div class="line"></div>
            </div>
            <core-selector id="list" layout vertical selected="{{selectedInstance}}" on-core-select="{{selectionChangedHandler}}" selectedProperty="selected">
              <template repeat="{{instance in buttList}}">
                <bh-instance 
                  style="min-height: {{toDays(instance.interval) * 20}}px"
                  date="{{instance.date}}" 
                  desc="{{instance.desc}}" 
                  src="{{instance.src}}">
                </bh-instance>
              </template>
            </core-selector>
          </div>
        </div>
      </core-header-panel>
      <div id="pagecontrols" horizontal layout center-justified>
        <paper-icon-button icon="av:fast-rewind" on-tap="{{firstHandler}}"></paper-icon-button>
        <paper-icon-button icon="hardware:keyboard-arrow-up" on-tap="{{prevHandler}}"></paper-icon-button>
        <paper-icon-button icon="hardware:keyboard-arrow-down" on-tap="{{nextHandler}}"></paper-icon-button>
        <paper-icon-button icon="av:fast-forward" on-tap="{{lastHandler}}"></paper-icon-button>
      </div>
    </div>
  </template>
  <script>
    Polymer("bh-app", {
      created: function(){
        this.buttList = [];
        this.selectedInstance = 0;
        this.tabIndex = 0;
        this.cachedY = 0; // needed to prevent browser from scrolling to previously selected instance before scrolling to selected instance.
        // this.focus();
        this.topMargin = 48;
      },
      ready: function(){
        this.focus();
      },
      // deltaDate: function(buttList){
      //   return _.tail(buttList).map(function(bh, index){
      //     return bh.date - buttList[index].date;
      //   })
      // },
      scrollHandler: function(e){
        // console.log(e);
        var trigger = _.throttle(function(){
          this.selectedInstance = this.findButthurtIndexFromScroll();
        }.bind(this), 200, {leading: false});
        trigger();
      },
      animateScroll: function(loc){
        // console.log(this.$.scrollpanel.scroller);
        $(this.$.scrollpanel.scroller).animate({ scrollTop: loc - this.topMargin + "px" });
      },
      getInstances: function(){
        return _.filter(this.$.list.children, function(instance){
          return instance.tagName === "BH-INSTANCE";
        }.bind(this));
      },
      nextHandler: function(e){
        if (this.selectedInstance < this.buttList.length - 1) {
          var target = this.getInstances()[this.findButthurtIndexFromScroll() + 1];
          this.animateToInstance(target);
        }
      },
      prevHandler: function(e){
        if (this.selectedInstance > 0) {
          var target = this.getInstances()[this.findButthurtIndexFromScroll() - 1];
          this.animateToInstance(target);
        }
      },
      firstHandler: function(e){
        var target = this.getInstances()[0];
        this.animateToInstance(target);
      },
      lastHandler: function(e){
        var target = _.last(this.getInstances());
        this.animateToInstance(target);
      },
      keyHandler: function(e){
        var keysPressed = function(keys){
          return _.contains(keys, e.keyCode);
        }
        if(keysPressed([32, 37, 38, 39, 40])) {
          e.preventDefault();
        }

        var nextKeys = [bh.arrowKeys.RIGHT, bh.arrowKeys.DOWN];
        var prevKeys = [bh.arrowKeys.LEFT, bh.arrowKeys.UP];

        if (keysPressed(nextKeys)) {
          this.nextHandler();

        } else if (keysPressed(prevKeys)) {
          this.prevHandler();

        }
      },
      selectionChangedHandler: function(e){
        // selection changed.
        // animate scroll to selected object
        // we already know the element that is selected

        // var y = e.detail.item.offsetTop;
        // if (this.cachedY != y) {
        //   this.cachedY = y;
        //   this.animateScroll(y);
        // }
      },

      animateToInstance: function(instance){
        // var target = _.filter(this.$.list.children, function(instance){
        //   return instance.tagName === "BH-INSTANCE";
        // }.bind(this))[this.selectedInstance];

        this.animateScroll(instance.offsetTop);
      },
      findButthurtIndexFromScroll: function(){
        var y = this.$.scrollpanel.scroller.scrollTop + this.topMargin;
        var butthurtIndex = 0;
        _.chain(this.$.list.children)
          .filter(function(instance){
            return instance.tagName === "BH-INSTANCE";
          })
          .find(function(instance, index, list){
            // var height = instance.offsetHeight;
            var top = instance.offsetTop;
            // console.log(list[index + 1].offsetTop);
            if (list[index + 1]) {
              var nextTop = list[index + 1].offsetTop;
            } else {
              var nextTop = instance.offsetHeight;
            }

            if (y >= top && y < nextTop) {
              butthurtIndex = index;
            }

            return y >= top && y < nextTop;
          })
          .value();
        return butthurtIndex;
      },
      latestDate: function(buttList){
        var date = _.chain(buttList)
          .sortBy("date")
          .last()
          .value();
        return date ? date.date : null;
      }, 
      toDays: function(date){
        //date is in milliseconds
        return date / 1000 / 60 / 60 / 24;
      },
      daysSinceDate: function(butthurtDate){
        // return Math.floor((new Date() - butthurtDate) / 1000 / 60 / 60 / 24);
        return this.dateInterval(new Date(), butthurtDate);
      },
      dateInterval: function(newDate, oldDate){
        return Math.floor(this.toDays(newDate - oldDate));
      },
      dataHandler: function(r, d){
        var results = Papa.parse(d.xhr.response);
        var labels = results.data.shift();
        this.buttList = _.chain(results.data)
          .map(function (r){
            var o = {};
            for (var i in r) o[labels[i]] = r[i];
            o.date = new Date(o.date);
            return o;
          })
          .reverse()
          .forEach(function(r, index, list){
            if (list[index + 1]) {
              r.interval = r.date - list[index + 1].date;
            } else {
              r.interval = 0;
            }
          })
          .value();
        
      },
      totalDays: function(list){
        if (list.length) {
          return this.daysSinceDate(_.head(list).date);
        } else {
          return 0;
        }
      },
      dataErrorHandler: function(r){
        console.log(r);
      } 
    });
  </script>
</polymer-element>