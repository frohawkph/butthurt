<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/core-ajax/core-ajax.html">
<link rel="import" href="bower_components/core-style/core-style.html">
<link rel="import" href="bh-instance.html">

<polymer-element name="bh-app" attributes="buttList">
  <template>
    <style>
      :host {
        font-family: Helvetica;
      }
      bh-instance {
        position: absolute;
        left: 50%;
        margin-left: -24px;
        z-index: 1;
      }
      .line-container {
        align-items: center;
      }
      .line {
        position: absolute;
        /*height: 100%;*/
        left: 50%;
        margin-left: -2px;
        width: 4px;
        background-color: #333;
        z-index: 0;
      }
      .banner {
        background-color: #333;
        text-align: center;
        color: white;
      }
    </style>
    <core-ajax
    auto
    url="data.csv"
    handleAs="text"
    on-core-error="{{dataErrorHandler}}"
    on-core-response="{{dataHandler}}"
    ></core-ajax>

    <div class="buttlist" layout vertical>
      <div class="banner">
        <h1>{{daysSinceDate(latestDate(buttList))}} days</h1>
        <p>since last butthurt</p>
      </div>
      <div layout vertical center>
        <template repeat="{{instance in buttList}}">
          <bh-instance 
            style="top: {{daysSinceDate(instance.date) * 20}}px"
            date="{{instance.date}}" 
            desc="{{instance.desc}}" 
            src="{{instance.src}}">
          </bh-instance>
        </template>
      </div>
    </div>
    <div class="line-container">
      <div class="line" style="height: {{totalDays(buttList) * 20}}px"></div>
    </div>
  </template>
  <script>
    Polymer("bh-app", {
      created: function(){
        this.buttList = [];
      },
      latestDate: function(buttList){
        var date = _.chain(buttList)
          .sortBy("date")
          .last()
          .value();
        return date ? date.date : null;
      }, 
      daysSinceDate: function(butthurtDate){
        return Math.floor((new Date() - butthurtDate) / 1000 / 60 / 60 / 24);
      },
      dataHandler: function(r, d){
        var results = Papa.parse(d.xhr.response);
        var labels = results.data.shift();
        this.buttList = results.data.map(function (r){
          var o = {};
          for (var i in r) o[labels[i]] = r[i];
          o.date = new Date(o.date);
          return o;
        });
        console.log(this.buttList);
      },
      totalDays: function(list){
        if (list.length) {
          return this.daysSinceDate(_.head(list).date);
        } else {
          return 0;
        }
      },
      dataErrorHandler: function(r){
        console.log(r);
      } 
    });
  </script>
</polymer-element>